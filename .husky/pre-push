protected_branch='master'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

echo "🌿 Current branch: $current_branch"
echo "🔒 Protected branch: $protected_branch"

if [ "$protected_branch" = "$current_branch" ]; then
  echo "🚫 Direct push to master branch is not allowed!"
  echo "📋 Please follow these steps:"
  echo "   1. Create a feature branch: git checkout -b feature/your-feature"
  echo "   2. Make your changes and commit them"
  echo "   3. Push the feature branch: git push origin feature/your-feature"
  echo "   4. Create a Pull Request to merge into master"
  exit 1
fi

echo "🔍 Running smart pre-push validation..."

# Kiểm tra lint và format song song
echo "📝 Checking code style..."
npm run lint:check &
npm run format:check &
wait

if git diff HEAD~1..HEAD --name-only | grep -qE '\.(ts|js)$'; then
  echo "🔧 TypeScript changes detected, running type check..."
  npx tsc --project tsconfig.typecheck.json
else
  echo "📝 No TypeScript changes, skipping type check"
fi

if git diff HEAD~1..HEAD --name-only | grep -q "prisma/"; then
  echo "🗄️ Prisma changes detected, validating..."
  npx prisma validate
else
  echo "📝 No Prisma changes, skipping validation"
fi

echo "🧪 Running tests (fast mode)..."
npm run test:fast

echo "✅ Pre-push validation passed!"
echo "🚀 Ready to push to branch: $current_branch"